# ISARA sample auto-mounting robot arm
# Status socket
#
# Macros
#  P    - Record name prefix
#  DEV  - asyn port name of status socket
#  SCAN - (Optional)  Default "1 second"

# Status chain

record(ai, "$(P)Scn:Strt-I_") {
    field(DTYP, "Soft Timestamp") # OS time at start of scan
    field(SCAN, "$(SCAN=1 second)")
    field(FLNK, "$(P)Pwr-Sts")
}

record(bi, "$(P)Pwr-Sts") {
    field(DTYP, "stream")
    field(INP , "@isara-status.proto state($(P)) $(DEV)")
    field(ZNAM, "Off")
    field(ONAM, "On")
    field(FLNK, "$(P)DI-I_")
}
record(bi, "$(P)Rmt-Sts") {
    field(ZNAM, "Local")
    field(ONAM, "Remote")
}
record(bi, "$(P)Flt-Sts") {
    field(ZNAM, "0")
    field(ONAM, "1")
}
record(stringin, "$(P)Tool-I") {}
record(stringin, "$(P)Pos:Name-I") {}
record(stringin, "$(P)Path:Name-I") {}
record(bi, "$(P)Grp:A-Sts") {
    field(ZNAM, "0")
    field(ONAM, "1")
}
record(bi, "$(P)Grp:B-Sts") {
    field(ZNAM, "0")
    field(ONAM, "1")
}
record(longin, "$(P)Pck:A-I") {}
record(longin, "$(P)Samp:A-I") {}
record(longin, "$(P)Pck:B-I") {}
record(longin, "$(P)Samp:B-I") {}
record(longin, "$(P)Pck:Dif-I") {}
record(longin, "$(P)Samp:Dif-I") {}
record(longin, "$(P)Plt:Tl-I") {}
record(longin, "$(P)Plt:Dif-I") {}
record(stringin, "$(P)DM:Lst-I") {}
record(bi, "$(P)Seq:Run-Sts") {
    field(ZNAM, "Stop")
    field(ONAM, "Move")
}
record(bi, "$(P)Seq:Paus-Sts") {
    field(ZNAM, "Normal")
    field(ONAM, "Pause")
}
record(ai, "$(P)Speed-I") {
    field(PREC, "1")
    field(EGU, "%")
}
record(bi, "$(P)LN2:Reg-Sts") {
    field(ZNAM, "Off")
    field(ONAM, "On")
}
record(longin, "$(P)LN2:SoakPha-I") {}
record(ai, "$(P)LN2:Lvl-I") {
    field(PREC, "1")
    field(EGU, "%")
}
record(ai, "$(P)LN2:Max-I") {
    field(PREC, "1")
    field(EGU, "%")
}
record(ai, "$(P)LN2:Min-I") {
    field(PREC, "1")
    field(EGU, "%")
}
record(bi, "$(P)CamTrk-Sts") {
    field(ZNAM, "Idle")
    field(ONAM, "Track")
}
record(bi, "$(P)GripDry-Sts") {
    field(ZNAM, "Idle")
    field(ONAM, "Drying")
}
record(bi, "$(P)LN2:PS-Sts") {
    field(ZNAM, "Off")
    field(ONAM, "On")
}
record(stringin, "$(P)LastMsg-I") {}
record(mbbiDirect, "$(P)Alarm-I") {
    field(NOBT, "32")
}
record(ai, "$(P)Pos:X-I") {
    field(PREC, "1")
    field(EGU , "mm")
}
record(ai, "$(P)Pos:Y-I") {
    field(PREC, "1")
    field(EGU , "mm")
}
record(ai, "$(P)Pos:Z-I") {
    field(PREC, "1")
    field(EGU , "mm")
}
record(ai, "$(P)Pos:RX-I") {
    field(PREC, "1")
    field(EGU , "deg")
}
record(ai, "$(P)Pos:RY-I") {
    field(PREC, "1")
    field(EGU , "deg")
}
record(ai, "$(P)Pos:RZ-I") {
    field(PREC, "1")
    field(EGU , "deg")
}


record(aai, "$(P)DI-I_") {
    field(FTVL, "SHORT")
    field(NELM, "256") # currently 112 will be used
    field(DTYP, "stream")
    field(INP , "@isara-status.proto bits(di) $(DEV)")
    field(FLNK, "$(P)DI:Chop-I_")
}

record(aSub, "$(P)DI:Chop-I_") {
    field(SNAM, "isara_chop_bits")

    field(FTA , "SHORT")
    field(NOA, "256")
    field(INPA, "$(P)DI-I_ NPP MSI")

    field(FTVA, "ULONG")
    field(OUTA, "$(P)DI:0-I PP MSI")
    field(FTVB, "ULONG")
    field(OUTB, "$(P)DI:1-I PP MSI")
    field(FTVC, "ULONG")
    field(OUTC, "$(P)DI:2-I PP MSI")
    field(FTVD, "ULONG")
    field(OUTD, "$(P)DI:3-I PP MSI")

    field(FLNK, "$(P)DO-I_")
}

record(mbbiDirect, "$(P)DI:0-I") {
    field(NOBT, "32")
}
record(mbbiDirect, "$(P)DI:1-I") {
    field(NOBT, "32")
}
record(mbbiDirect, "$(P)DI:2-I") {
    field(NOBT, "32")
}
record(mbbiDirect, "$(P)DI:3-I") {
    field(NOBT, "32")
}

record(aai, "$(P)DO-I_") {
    field(FTVL, "SHORT")
    field(NELM, "256") # currently 112 will be used
    field(DTYP, "stream")
    field(INP , "@isara-status.proto bits(do) $(DEV)")
    field(FLNK, "$(P)DO:Chop-I_")
}

record(aSub, "$(P)DO:Chop-I_") {
    field(SNAM, "isara_chop_bits")

    field(FTA , "SHORT")
    field(NOA, "256")
    field(INPA, "$(P)DO-I_ NPP MSI")

    field(FTVA, "ULONG")
    field(OUTA, "$(P)DO:0-I PP MSI")
    field(FTVB, "ULONG")
    field(OUTB, "$(P)DO:1-I PP MSI")
    field(FTVC, "ULONG")
    field(OUTC, "$(P)DO:2-I PP MSI")
    field(FTVD, "ULONG")
    field(OUTD, "$(P)DO:3-I PP MSI")

    field(FLNK, "$(P)Scn:End-I_")
}

record(mbbiDirect, "$(P)DO:0-I") {
    field(NOBT, "32")
}
record(mbbiDirect, "$(P)DO:1-I") {
    field(NOBT, "32")
}
record(mbbiDirect, "$(P)DO:2-I") {
    field(NOBT, "32")
}
record(mbbiDirect, "$(P)DO:3-I") {
    field(NOBT, "32")
}

# status scan status

record(ai, "$(P)Scn:End-I_") {
    field(DTYP, "Soft Timestamp") # OS time at end of scan
    field(FLNK, "$(P)Scn:Tm-I")
}

record(calc, "$(P)Scn:Tm-I") {
    field(INPA, "$(P)Scn:Strt-I_")
    field(INPB, "$(P)Scn:End-I_")
    field(INPC, "1000")
    field(CALC, "(B-A)*C")
    field(EGU , "ms")
    field(PREC, "3")
    field(FLNK, "$(P)Scn:Cnt-Calc_")
}

record(calc, "$(P)Scn:Cnt-Calc_") {
    field(CALC, "(VAL+1)%0xffff")
}

record(calc, "$(P)Scn:Rate-I") {
    field(SCAN, "10 second")
    field(INPA, "$(P)Scn:Cnt-Calc_")
    field(CALC, "C:=A-B;B:=A;C/10")
    field(EGU , "Hz")
    field(PREC, "1")
    field(HIGH, "2")
    field(LOW , "0.1")
    field(HSV , "MAJOR")
    field(LSV , "MAJOR")
}
